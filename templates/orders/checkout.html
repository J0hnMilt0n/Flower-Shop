{% extends 'base.html' %}
{% load humanize %}
{% block title %}Checkout | Bloomify{% endblock %}
{% block content %}
<div class="bg-gradient-to-r from-primary-50 to-secondary-50 py-8">
  <div class="container mx-auto px-4">
    <h1 class="font-display text-3xl md:text-4xl font-bold text-gray-800">
      Checkout
    </h1>
  </div>
</div>

<div class="container mx-auto px-4 py-8">
  <form method="POST" id="checkout-form">
    {% csrf_token %}
    
    {% if form.errors %}
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
      <p class="font-medium mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Please fix the following errors:</p>
      <ul class="list-disc list-inside text-sm">
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Delivery Address -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">
              <span
                class="bg-primary-100 text-primary-600 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2"
                >1</span
              >
              Delivery Address
            </h2>
            <button
              type="button"
              onclick="openAddressModal()"
              class="text-primary-600 hover:underline text-sm"
            >
              <i class="fas fa-plus mr-1"></i> Add New Address
            </button>
          </div>

          {% if addresses %}
          <div class="grid md:grid-cols-2 gap-4">
            {% for address in addresses %}
            <label class="relative cursor-pointer">
              <input
                type="radio"
                name="address"
                value="{{ address.id }}"
                {% if address.is_default or forloop.first %}checked{% endif %}
                class="peer hidden"
              />
              <div
                class="border-2 rounded-xl p-4 peer-checked:border-primary-500 peer-checked:bg-primary-50 transition"
              >
                <div class="flex items-center justify-between mb-2">
                  <span
                    class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full"
                  >
                    {{ address.get_address_type_display }}
                  </span>
                  {% if address.is_default %}
                  <span class="text-primary-600 text-xs">Default</span>
                  {% endif %}
                </div>
                <h4 class="font-semibold">{{ address.full_name }}</h4>
                <p class="text-sm text-gray-600 mt-1">
                  {{ address.address_line1 }}<br />
                  {% if address.address_line2 %}{{ address.address_line2 }}<br />{% endif %}
                  {{ address.city }}, {{ address.state }} - {{ address.pincode }}
                </p>
                <p class="text-sm text-gray-500 mt-2">
                  <i class="fas fa-phone mr-1"></i> {{ address.phone }}
                </p>
              </div>
            </label>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-8 bg-gray-50 rounded-xl">
            <i class="fas fa-map-marker-alt text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-4">No saved addresses found</p>
            <button
              type="button"
              onclick="openAddressModal()"
              class="bg-primary-500 text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition"
            >
              Add New Address
            </button>
          </div>
          {% endif %}
        </div>

        <!-- Delivery Options -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-semibold mb-6">
            <span
              class="bg-primary-100 text-primary-600 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2"
              >2</span
            >
            Delivery Options
          </h2>

          <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-gray-700 mb-2">Delivery Date*</label>
              {{ form.delivery_date }}
            </div>
            <div>
              <label class="block text-gray-700 mb-2">Time Slot*</label>
              {{ form.delivery_time_slot }}
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-gray-700 mb-2">Special Instructions</label>
            {{ form.special_instructions }}
          </div>

          <div class="flex items-center mb-4">
            {{ form.is_gift }}
            <label class="ml-2 text-gray-700">This is a gift</label>
          </div>

          <div id="gift-message-wrapper" class="hidden">
            <label class="block text-gray-700 mb-2">Gift Message</label>
            {{ form.gift_message }}
          </div>
        </div>

        <!-- Payment Method -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-semibold mb-6">
            <span
              class="bg-primary-100 text-primary-600 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2"
              >3</span
            >
            Payment Method
          </h2>

          <div class="space-y-4">
            <label
              class="flex items-center p-4 border-2 rounded-xl cursor-pointer hover:border-primary-300 has-[:checked]:border-primary-500 has-[:checked]:bg-primary-50"
            >
              <input
                type="radio"
                name="payment_method"
                value="razorpay"
                checked
                class="h-4 w-4 text-primary-600 focus:ring-primary-500"
              />
              <div class="ml-4 flex-1">
                <div class="flex items-center justify-between">
                  <span class="font-medium">Pay Online (Razorpay)</span>
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Razorpay_logo.svg/120px-Razorpay_logo.svg.png"
                    alt="Razorpay"
                    class="h-6"
                  />
                </div>
                <p class="text-sm text-gray-500 mt-1">
                  UPI, Cards, Net Banking, Wallets
                </p>
              </div>
            </label>

            <label
              class="flex items-center p-4 border-2 rounded-xl cursor-pointer hover:border-primary-300 has-[:checked]:border-primary-500 has-[:checked]:bg-primary-50"
            >
              <input
                type="radio"
                name="payment_method"
                value="cod"
                class="h-4 w-4 text-primary-600 focus:ring-primary-500"
              />
              <div class="ml-4">
                <span class="font-medium">Cash on Delivery (COD)</span>
                <p class="text-sm text-gray-500 mt-1">
                  Pay when you receive your order
                </p>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
          <h2 class="text-xl font-semibold mb-6">Order Summary</h2>

          <!-- Cart Items -->
          <div class="space-y-4 mb-6">
            {% for item in cart %}
            <div class="flex gap-3">
              <div
                class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0"
              >
                {% if item.product.image %}
                <img
                  src="{{ item.product.image.url }}"
                  alt=""
                  class="w-full h-full object-cover"
                />
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                  ðŸŒ¸
                </div>
                {% endif %}
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-medium text-gray-800 line-clamp-1">
                  {{ item.product.name }}
                </h4>
                <p class="text-xs text-gray-500">Qty: {{ item.quantity }}</p>
                <p class="text-sm font-medium text-primary-600">
                  â‚¹{{ item.total_price|intcomma }}
                </p>
              </div>
            </div>
            {% endfor %}
          </div>

          <hr class="mb-6" />

          <!-- Totals -->
          <div class="space-y-3 mb-6">
            <div class="flex justify-between text-gray-600">
              <span>Subtotal</span>
              <span>â‚¹{{ cart.get_total_price|intcomma }}</span>
            </div>
            {% if coupon %}
            <div class="flex justify-between text-green-600">
              <span>Discount ({{ coupon.code }})</span>
              <span>-â‚¹{{ cart.get_discount|intcomma }}</span>
            </div>
            {% endif %}
            <div class="flex justify-between text-gray-600">
              <span>Delivery</span>
              <span
                >{% if cart.get_total_price >= 500 %}<span
                  class="text-green-600"
                  >FREE</span
                >{% else %}â‚¹50{% endif %}</span
              >
            </div>
            <hr />
            <div class="flex justify-between text-xl font-bold">
              <span>Total</span>
              <span class="text-primary-600">
                {% if coupon %}â‚¹{{ cart.get_final_total|intcomma }}{% else %}â‚¹{% if cart.get_total_price >= 500 %}{{ cart.get_total_price|intcomma }}{% else %}{{ cart.get_total_price|add:50|intcomma }}{% endif %}{% endif %}
              </span>
            </div>
          </div>

          <!-- Place Order -->
          <button
            type="submit"
            class="w-full bg-primary-500 text-white py-4 rounded-full font-semibold hover:bg-primary-600 transition"
          >
            Place Order <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <p class="text-xs text-gray-500 text-center mt-4">
            By placing this order, you agree to our
            <a href="#" class="text-primary-600 hover:underline"
              >Terms & Conditions</a
            >
          </p>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Add Address Modal -->
<div
  id="address-modal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center"
>
  <div
    class="bg-white rounded-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto"
  >
    <div class="p-6 border-b flex items-center justify-between">
      <h3 class="text-xl font-semibold">Add New Address</h3>
      <button
        onclick="closeAddressModal()"
        class="text-gray-400 hover:text-gray-600"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <form method="POST" action="{% url 'orders:add_address' %}" class="p-6">
      {% csrf_token %}
      <div class="space-y-4">
        <div>
          {{ address_form.address_type.label_tag }} {{ address_form.address_type }}
        </div>
        <div>
          {{ address_form.full_name.label_tag }} {{ address_form.full_name }}
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>{{ address_form.phone.label_tag }} {{ address_form.phone }}</div>
          <div>
            {{ address_form.alternate_phone.label_tag }} {{ address_form.alternate_phone }}
          </div>
        </div>
        <div>
          {{ address_form.address_line1.label_tag }} {{ address_form.address_line1 }}
        </div>
        <div>
          {{ address_form.address_line2.label_tag }} {{ address_form.address_line2 }}
        </div>
        <div>
          {{ address_form.landmark.label_tag }} {{ address_form.landmark }}
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div>{{ address_form.city.label_tag }} {{ address_form.city }}</div>
          <div>{{ address_form.state.label_tag }} {{ address_form.state }}</div>
          <div>
            {{ address_form.pincode.label_tag }} {{ address_form.pincode }}
          </div>
        </div>
        <div class="flex items-center">
          {{ address_form.is_default }}
          <label class="ml-2 text-gray-700">Set as default address</label>
        </div>
      </div>
      <div class="mt-6">
        <button
          type="submit"
          class="w-full bg-primary-500 text-white py-3 rounded-lg hover:bg-primary-600 transition"
        >
          Save Address
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  function openAddressModal() {
    document.getElementById("address-modal").classList.remove("hidden");
    document.getElementById("address-modal").classList.add("flex");
    document.body.style.overflow = "hidden";
  }

  function closeAddressModal() {
    document.getElementById("address-modal").classList.add("hidden");
    document.getElementById("address-modal").classList.remove("flex");
    document.body.style.overflow = "auto";
  }

  // Toggle gift message
  document
    .querySelector('[name="is_gift"]')
    .addEventListener("change", function () {
      document
        .getElementById("gift-message-wrapper")
        .classList.toggle("hidden", !this.checked);
    });

  // Set minimum delivery date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.querySelector('[name="delivery_date"]').min = tomorrow
    .toISOString()
    .split("T")[0];
</script>
{% endblock %}
