{% extends 'base.html' %}
{% load humanize %}

{% block title %}Order {{ order.order_id }} | Bloomify Admin{% endblock %}

{% block content %}
<div class="bg-gradient-to-r from-primary-500 to-primary-600 py-8">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between">
            <div>
                <a href="{% url 'shop:order_management' %}" class="text-primary-100 hover:text-white mb-2 inline-block">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Orders
                </a>
                <h1 class="font-display text-3xl md:text-4xl font-bold text-white">Order {{ order.order_id }}</h1>
                <p class="text-primary-100 mt-2">{{ order.created_at|date:"F d, Y h:i A" }}</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openStatusModal('{{ order.order_id }}', '{{ order.status }}')"
                        class="bg-white text-primary-600 px-6 py-3 rounded-full font-semibold hover:bg-primary-50 transition shadow-lg">
                    <i class="fas fa-edit mr-2"></i> Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Order Status -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Status</h2>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        {% if order.status == 'pending' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-gray-100 text-gray-700">
                            <i class="fas fa-clock mr-2"></i> Pending
                        </span>
                        {% elif order.status == 'confirmed' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-blue-100 text-blue-700">
                            <i class="fas fa-thumbs-up mr-2"></i> Confirmed
                        </span>
                        {% elif order.status == 'processing' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-purple-100 text-purple-700">
                            <i class="fas fa-cog mr-2"></i> Processing
                        </span>
                        {% elif order.status == 'out_for_delivery' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-orange-100 text-orange-700">
                            <i class="fas fa-truck mr-2"></i> Out for Delivery
                        </span>
                        {% elif order.status == 'delivered' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-green-100 text-green-700">
                            <i class="fas fa-check-circle mr-2"></i> Delivered
                        </span>
                        {% elif order.status == 'cancelled' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-red-100 text-red-700">
                            <i class="fas fa-times-circle mr-2"></i> Cancelled
                        </span>
                        {% endif %}
                        
                        {% if order.payment_status == 'paid' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-green-100 text-green-700 ml-2">
                            <i class="fas fa-check-circle mr-2"></i> Paid
                        </span>
                        {% elif order.payment_status == 'pending' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-yellow-100 text-yellow-700 ml-2">
                            <i class="fas fa-clock mr-2"></i> Payment Pending
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm bg-red-100 text-red-700 ml-2">
                            <i class="fas fa-times-circle mr-2"></i> Payment {{ order.payment_status|title }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Status Buttons -->
                <div class="mt-6 pt-4 border-t">
                    <p class="text-sm text-gray-500 mb-3">Quick Status Update:</p>
                    <div class="flex flex-wrap gap-2">
                        <form action="{% url 'shop:order_update_status' order.order_id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="confirmed">
                            <button type="submit" class="px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition {% if order.status == 'confirmed' %}ring-2 ring-blue-500{% endif %}">
                                <i class="fas fa-thumbs-up mr-1"></i> Confirmed
                            </button>
                        </form>
                        <form action="{% url 'shop:order_update_status' order.order_id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="processing">
                            <button type="submit" class="px-4 py-2 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition {% if order.status == 'processing' %}ring-2 ring-purple-500{% endif %}">
                                <i class="fas fa-cog mr-1"></i> Processing
                            </button>
                        </form>
                        <form action="{% url 'shop:order_update_status' order.order_id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="out_for_delivery">
                            <button type="submit" class="px-4 py-2 text-sm bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition {% if order.status == 'out_for_delivery' %}ring-2 ring-orange-500{% endif %}">
                                <i class="fas fa-truck mr-1"></i> Out for Delivery
                            </button>
                        </form>
                        <form action="{% url 'shop:order_update_status' order.order_id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="delivered">
                            <button type="submit" class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition {% if order.status == 'delivered' %}ring-2 ring-green-500{% endif %}">
                                <i class="fas fa-check-circle mr-1"></i> Delivered
                            </button>
                        </form>
                        <form action="{% url 'shop:order_update_status' order.order_id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="cancelled">
                            <button type="submit" class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition {% if order.status == 'cancelled' %}ring-2 ring-red-500{% endif %}"
                                    onclick="return confirm('Are you sure you want to cancel this order?')">
                                <i class="fas fa-times-circle mr-1"></i> Cancel
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Items</h2>
                <div class="space-y-4">
                    {% for item in order.items.all %}
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                            {% if item.product_image %}
                            <img src="{{ item.product_image.url }}" alt="{{ item.product_name }}" class="w-full h-full object-cover">
                            {% elif item.product and item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="fas fa-image"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">{{ item.product_name }}</p>
                            <p class="text-sm text-gray-500">Qty: {{ item.quantity }} × ₹{{ item.price|intcomma }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">₹{{ item.get_total|intcomma }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tracking History -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Tracking History</h2>
                    <button onclick="openTrackingModal()" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> Add Entry
                    </button>
                </div>
                
                {% if tracking %}
                <div class="relative">
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                    {% for track in tracking %}
                    <div class="relative pl-10 pb-6 last:pb-0">
                        <div class="absolute left-0 w-8 h-8 rounded-full flex items-center justify-center {% if forloop.first %}bg-primary-500 text-white{% else %}bg-gray-200 text-gray-500{% endif %}">
                            {% if 'Delivered' in track.status %}
                            <i class="fas fa-check text-sm"></i>
                            {% elif 'Out for' in track.status %}
                            <i class="fas fa-truck text-sm"></i>
                            {% elif 'Processing' in track.status %}
                            <i class="fas fa-cog text-sm"></i>
                            {% elif 'Confirmed' in track.status %}
                            <i class="fas fa-thumbs-up text-sm"></i>
                            {% elif 'Cancelled' in track.status %}
                            <i class="fas fa-times text-sm"></i>
                            {% else %}
                            <i class="fas fa-box text-sm"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800">{{ track.status }}</h4>
                            <p class="text-sm text-gray-500">{{ track.description }}</p>
                            {% if track.location %}
                            <p class="text-xs text-gray-400"><i class="fas fa-map-marker-alt mr-1"></i> {{ track.location }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-400 mt-1">{{ track.created_at|date:"M d, Y h:i A" }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">No tracking entries yet</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Customer Info -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Customer Details</h2>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-500">Name</p>
                        <p class="font-medium text-gray-800">{{ order.full_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Email</p>
                        <p class="font-medium text-gray-800">{{ order.email }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Phone</p>
                        <p class="font-medium text-gray-800">{{ order.phone }}</p>
                    </div>
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Delivery Address</h2>
                <p class="text-gray-600">
                    {{ order.address_line1 }}<br>
                    {% if order.address_line2 %}{{ order.address_line2 }}<br>{% endif %}
                    {% if order.landmark %}Near {{ order.landmark }}<br>{% endif %}
                    {{ order.city }}, {{ order.state }} - {{ order.pincode }}
                </p>
                {% if order.delivery_date %}
                <div class="mt-4 pt-4 border-t">
                    <p class="text-sm text-gray-500">Delivery Date</p>
                    <p class="font-medium text-gray-800">{{ order.delivery_date|date:"F d, Y" }}</p>
                    {% if order.delivery_time_slot %}
                    <p class="text-sm text-gray-600">{{ order.delivery_time_slot }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Summary</h2>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Subtotal</span>
                        <span class="text-gray-800">₹{{ order.subtotal|intcomma }}</span>
                    </div>
                    {% if order.discount > 0 %}
                    <div class="flex justify-between text-green-600">
                        <span>Discount</span>
                        <span>-₹{{ order.discount|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% if order.coupon_discount > 0 %}
                    <div class="flex justify-between text-green-600">
                        <span>Coupon ({{ order.coupon_code }})</span>
                        <span>-₹{{ order.coupon_discount|intcomma }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-500">Delivery</span>
                        <span class="text-gray-800">{% if order.delivery_charge > 0 %}₹{{ order.delivery_charge|intcomma }}{% else %}Free{% endif %}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t font-semibold text-lg">
                        <span class="text-gray-800">Total</span>
                        <span class="text-primary-600">₹{{ order.total|intcomma }}</span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <p class="text-sm text-gray-500">Payment Method</p>
                    <p class="font-medium text-gray-800">{{ order.get_payment_method_display }}</p>
                </div>
            </div>

            <!-- Special Instructions -->
            {% if order.special_instructions or order.gift_message %}
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Notes</h2>
                {% if order.special_instructions %}
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Special Instructions</p>
                    <p class="text-gray-600">{{ order.special_instructions }}</p>
                </div>
                {% endif %}
                {% if order.gift_message %}
                <div>
                    <p class="text-sm text-gray-500">Gift Message</p>
                    <p class="text-gray-600 italic">"{{ order.gift_message }}"</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">Update Order Status</h3>
            <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="statusForm" method="post" action="{% url 'shop:order_update_status' order.order_id %}">
            {% csrf_token %}
            <p class="text-gray-600 mb-4">Order: <strong id="modalOrderId">{{ order.order_id }}</strong></p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                <select name="status" id="statusSelect" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="out_for_delivery" {% if order.status == 'out_for_delivery' %}selected{% endif %}>Out for Delivery</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                <textarea name="notes" rows="2" 
                          class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300"
                          placeholder="Add tracking notes..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-primary-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-600 transition">
                    <i class="fas fa-check mr-2"></i> Update Status
                </button>
                <button type="button" onclick="closeStatusModal()" class="px-6 py-3 border rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Tracking Entry Modal -->
<div id="trackingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">Add Tracking Entry</h3>
            <button onclick="closeTrackingModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form method="post" action="{% url 'shop:order_add_tracking' order.order_id %}">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Status Title</label>
                <input type="text" name="status" required
                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300"
                       placeholder="e.g., Package picked up">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea name="description" rows="2" 
                          class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300"
                          placeholder="Details about this update..."></textarea>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Location (optional)</label>
                <input type="text" name="location"
                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300"
                       placeholder="e.g., Mumbai Hub">
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-primary-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-600 transition">
                    <i class="fas fa-plus mr-2"></i> Add Entry
                </button>
                <button type="button" onclick="closeTrackingModal()" class="px-6 py-3 border rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openStatusModal(orderId, currentStatus) {
    document.getElementById('statusSelect').value = currentStatus;
    document.getElementById('statusModal').classList.remove('hidden');
    document.getElementById('statusModal').classList.add('flex');
}

function closeStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
    document.getElementById('statusModal').classList.remove('flex');
}

function openTrackingModal() {
    document.getElementById('trackingModal').classList.remove('hidden');
    document.getElementById('trackingModal').classList.add('flex');
}

function closeTrackingModal() {
    document.getElementById('trackingModal').classList.add('hidden');
    document.getElementById('trackingModal').classList.remove('flex');
}

// Close modals when clicking outside
document.getElementById('statusModal').addEventListener('click', function(e) {
    if (e.target === this) closeStatusModal();
});
document.getElementById('trackingModal').addEventListener('click', function(e) {
    if (e.target === this) closeTrackingModal();
});
</script>
{% endblock %}
